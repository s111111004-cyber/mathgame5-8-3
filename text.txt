<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æ•¸çš„æ¯”å¤§å° PK æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šä¸»è¦å­—é«”ç‚º Inter (é€šç”¨ä¸”æ˜“è®€) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7ffee; /* æ·ºé»ƒç¶ è‰²èƒŒæ™¯ï¼Œé©åˆå­¸ç¿’ */
        }
        /* å®šç¾©åˆ†æ•¸é¡¯ç¤ºæ¨£å¼ */
        .fraction-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem; /* å¤§å­—é«” */
            font-weight: 700;
            line-height: 1; /* èª¿æ•´è¡Œé«˜è®“åˆ†å­åˆ†æ¯é è¿‘ */
            margin: 0 1rem;
            color: #333;
        }
        .fraction-separator {
            width: 100%;
            height: 4px; /* æ‰å¹³çš„åˆ†éš”ç·š */
            background-color: #333;
            margin: 2px 0; /* å¾®èª¿ä¸Šä¸‹é–“è· */
        }
        .numerator {
            padding-bottom: 5px; /* çµ¦åˆ†å­ä¸€é»ç©ºé–“ */
        }
        .denominator {
            padding-top: 5px; /* çµ¦åˆ†æ¯ä¸€é»ç©ºé–“ */
        }
        
        /* ç©å®¶è³‡è¨Šæ°´å¹³é¡¯ç¤ºåœ¨å·¦ä¸Š/å³ä¸Š */
        .player-info {
            white-space: nowrap;
            position: absolute;
            top: 1rem; /* è·é›¢é ‚éƒ¨ 1rem */
            font-size: 1.5rem;
            font-weight: bold;
            padding: 0.5rem 1rem; /* å¢åŠ æ°´å¹³ padding */
            background: rgba(255, 255, 255, 0.9); /* æ›´å¯¦å¿ƒçš„èƒŒæ™¯ */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* æ›´æ˜é¡¯çš„é™°å½± */
            z-index: 10; /* ç¢ºä¿åˆ†æ•¸åœ¨æœ€ä¸Šå±¤ */
            transform: none !important; /* ç§»é™¤æ‰€æœ‰æ—‹è½‰ */
        }
        #p1-score-display {
            left: 1rem; 
        }
        #p2-score-display {
            right: 1rem;
        }

        /* ç¢ºä¿æŒ‰éˆ•æœ‰è¶³å¤ çš„è§¸æ§é¢ç© */
        .symbol-btn {
            min-height: 48px; /* æœ€å°è§¸æ§ç›®æ¨™å°ºå¯¸ */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ç©å®¶ä¸€è³‡è¨Š (å·¦ä¸Šè§’) -->
    <div id="p1-score-display" class="player-info text-blue-600 border-b-2 border-blue-400 hidden">
        ç©å®¶ä¸€: 0 åˆ†
    </div>

    <!-- ç©å®¶äºŒè³‡è¨Š (å³ä¸Šè§’) -->
    <div id="p2-score-display" class="player-info text-red-600 border-b-2 border-red-400 hidden">
        ç©å®¶äºŒ: 0 åˆ†
    </div>

    <div id="app" class="bg-white rounded-2xl shadow-2xl p-6 md:p-10 w-full max-w-4xl text-center border-4 border-lime-600 relative">
        <!-- å…§å®¹å°‡ç”± JavaScript å‹•æ…‹æ’å…¥ -->
    </div>


    <script type="text/javascript">
        // æ‡‰ç”¨ç¨‹å¼ ID å’Œ Firebase é…ç½® (å³ä½¿ä¸ä½¿ç”¨ Firestore ä¹Ÿè¦åŒ…å«é€™äº›è®Šæ•¸ä»¥ä¿æŒä»£ç¢¼ä¸€è‡´æ€§)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // æ­¤ç‰ˆæœ¬å·²ç§»é™¤ Gemini API ç›¸é—œè¨­å®š

        const appElement = document.getElementById('app');
        let currentQuestionIndex = 0;
        let isAnswerLocked = false; // é˜²æ­¢é‡è¤‡é»æ“Š

        let player1Score = 0;
        let player2Score = 0;

        // å®šç¾©éµç›¤å°æ‡‰ (åŠŸèƒ½ä¿ç•™ï¼Œä½† UI ä¸é¡¯ç¤º)
        const player1Keys = { 'a': '<', 's': '=', 'd': '>' };
        const player2Keys = { 'j': '<', 'k': '=', 'l': '>' };

        // å•é¡Œè³‡æ–™é›†
        const questions = [
            // è¦–è¦ºé¡Œ (3é¡Œ)
            { n1: 3, d1: 5, n2: 4, d2: 5, answer: '<', type: 'visual', title: 'ç¬¬ 1 é¡Œ (é•·æ–¹å½¢è¼”åŠ©)', modelType: 'bar' },
            { n1: 7, d1: 8, n2: 5, d2: 8, answer: '>', type: 'visual', title: 'ç¬¬ 2 é¡Œ (åœ“å½¢è¼”åŠ©)', modelType: 'circle' },
            { n1: 2, d1: 4, n2: 2, d2: 4, answer: '=', type: 'visual', title: 'ç¬¬ 3 é¡Œ (æ­£æ–¹å½¢è¼”åŠ©)', modelType: 'square' },
            // æ•¸å­—é¡Œ (5é¡Œ)
            { n1: 1, d1: 6, n2: 4, d2: 6, answer: '<', type: 'numeric', title: 'ç¬¬ 4 é¡Œ (æ•¸å­—æ¯”è¼ƒ)' },
            { n1: 9, d1: 10, n2: 3, d2: 10, answer: '>', type: 'numeric', title: 'ç¬¬ 5 é¡Œ (æ•¸å­—æ¯”è¼ƒ)' },
            { n1: 5, d1: 12, n2: 5, d2: 12, answer: '=', type: 'numeric', title: 'ç¬¬ 6 é¡Œ (æ•¸å­—æ¯”è¼ƒ)' },
            { n1: 8, d1: 9, n2: 7, d2: 9, answer: '>', type: 'numeric', title: 'ç¬¬ 7 é¡Œ (æ•¸å­—æ¯”è¼ƒ)' },
            { n1: 1, d1: 3, n2: 2, d2: 3, answer: '<', type: 'numeric', title: 'ç¬¬ 8 é¡Œ (æ•¸å­—æ¯”è¼ƒ)' }
        ];

        /**
         * å‰µå»ºè‡ªè¨‚åˆ†æ•¸é¡¯ç¤ºæ ¼å¼çš„ HTML çµæ§‹
         * @param {number} n åˆ†å­ (Numerator)
         * @param {number} d åˆ†æ¯ (Denominator)
         * @returns {string} HTML å­—ä¸²
         */
        function createFractionHTML(n, d) {
            return `
                <div class="fraction-display w-20">
                    <div class="numerator">${n}</div>
                    <div class="fraction-separator"></div>
                    <div class="denominator">${d}</div>
                </div>
            `;
        }

        /**
         * å‰µå»ºé•·æ–¹å½¢åœ–å½¢è¡¨ç¤º (Bar Model)
         * @param {number} n åˆ†å­
         * @param {number} d åˆ†æ¯
         * @returns {HTMLElement} è¦–è¦ºåŒ–å…ƒç´ 
         */
        function createBarModel(n, d) {
            const container = document.createElement('div');
            // é•·æ¢åœ–å¯¬åº¦ä½¿ç”¨ w-40, è®“å®ƒåœ¨æ°´å¹³æ’åˆ—æ™‚æ›´çªå‡º
            container.className = 'flex w-40 h-8 border-2 border-gray-400 rounded-lg overflow-hidden shadow-md mx-auto my-1';

            for (let i = 0; i < d; i++) {
                const segment = document.createElement('div');
                // ä½¿ç”¨ Tailwind çš„ indigo-400 ä½œç‚ºå¡«å……è‰²
                segment.className = `flex-1 h-full ${i < n ? 'bg-indigo-400' : 'bg-gray-200'}`;
                if (i < d - 1) {
                    segment.style.borderRight = '1px solid #aaa';
                }
                container.appendChild(segment);
            }
            return container;
        }

        /**
         * å‰µå»ºåœ“å½¢åœ–å½¢è¡¨ç¤º (Circle Model/é¤…åœ– - ä½¿ç”¨ conic-gradient)
         * @param {number} n åˆ†å­
         * @param {number} d åˆ†æ¯
         * @returns {HTMLElement} è¦–è¦ºåŒ–å…ƒç´ 
         */
        function createCircleModel(n, d) {
            const container = document.createElement('div');
            container.className = 'w-20 h-20 rounded-full border-2 border-gray-400 shadow-md mx-auto my-1 relative overflow-hidden flex items-center justify-center';

            // è¨ˆç®—å¡«æ»¿çš„ç™¾åˆ†æ¯”
            const fillPercentage = (n / d) * 100;
            
            // ä½¿ç”¨ conic-gradient å‰µå»ºæ‰‡å½¢
            // å¡«å……è‰²ä½¿ç”¨æ·±è—è‰² (#4f46e5 / indigo-600)
            // ç©ºç™½è‰²ä½¿ç”¨æ·ºç°è‰² (#e5e7eb / gray-200)
            container.style.background = `conic-gradient(
                #4f46e5 0% ${fillPercentage}%,
                #e5e7eb ${fillPercentage}% 100%
            )`;

            return container;
        }

        /**
         * å‰µå»ºæ–¹å½¢åœ–å½¢è¡¨ç¤º (Square Model - ä½¿ç”¨ CSS Grid, å°ˆé–€è™•ç† d=4)
         * @param {number} n åˆ†å­
         * @param {number} d åˆ†æ¯
         * @returns {HTMLElement} è¦–è¦ºåŒ–å…ƒç´ 
         */
        function createSquareModel(n, d) {
            const squareContainer = document.createElement('div');
            squareContainer.className = 'w-20 h-20 border-2 border-gray-400 rounded-lg shadow-md mx-auto my-1 overflow-hidden';
            
            let cols = 1;
            if (d === 4) cols = 2; // 2x2 grid
            else if (d === 9) cols = 3; // 3x3 grid
            else if (d === 16) cols = 4; // 4x4 grid
            
            if (cols > 1) {
                // 2x2, 3x3, or 4x4 grid
                squareContainer.classList.add('grid');
                squareContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                squareContainer.style.gridTemplateRows = `repeat(${cols}, 1fr)`;

                for (let i = 0; i < d; i++) {
                    const segment = document.createElement('div');
                    
                    let classes = `h-full w-full ${i < n ? 'bg-indigo-400' : 'bg-gray-200'}`;
                    
                    // å…§éƒ¨é‚Šç•Œç·šï¼Œé¿å…è¦†è“‹å¤–éƒ¨é‚Šç•Œ
                    if (Math.floor(i / cols) < (cols - 1)) classes += ' border-b border-gray-400';
                    if (i % cols < (cols - 1)) classes += ' border-r border-gray-400';

                    segment.className = classes;
                    squareContainer.appendChild(segment);
                }
            } else {
                // å°æ–¼éå®Œç¾å¹³æ–¹çš„åˆ†æ¯ï¼Œé€€å›åˆ°é•·æ¢åˆ†å‰²æ¨¡å¼ï¼Œä½†ä¿æŒæ­£æ–¹å½¢é•·å¯¬æ¯”
                 squareContainer.classList.add('flex');
                 for (let i = 0; i < d; i++) {
                     const segment = document.createElement('div');
                     segment.className = `flex-1 h-full ${i < n ? 'bg-indigo-400' : 'bg-gray-200'}`;
                     if (i < d - 1) {
                         segment.style.borderRight = '1px solid #aaa';
                     }
                     squareContainer.appendChild(segment);
                 }
            }
            return squareContainer;
        }

        /**
         * å‰µå»ºè¦–è¦ºæ¨¡å‹çš„åˆ†ç™¼å™¨ (Dispatcher)
         * @param {string} type æ¨¡å‹é¡å‹ ('bar', 'circle', 'square')
         * @param {number} n åˆ†å­
         * @param {number} d åˆ†æ¯
         * @returns {HTMLElement} è¦–è¦ºåŒ–å…ƒç´ 
         */
        function createVisualModel(type, n, d) {
            switch (type) {
                case 'bar':
                    return createBarModel(n, d);
                case 'circle':
                    return createCircleModel(n, d);
                case 'square':
                    return createSquareModel(n, d);
                default:
                    return createBarModel(n, d); // é è¨­ä½¿ç”¨é•·æ¢åœ–
            }
        }

        /**
         * æ›´æ–°åˆ†æ•¸é¡¯ç¤º
         */
        function updateScoreDisplay() {
            const p1Display = document.getElementById('p1-score-display');
            const p2Display = document.getElementById('p2-score-display');

            if (p1Display) {
                p1Display.textContent = `ç©å®¶ä¸€: ${player1Score} åˆ†`;
            }
            if (p2Display) {
                p2Display.textContent = `ç©å®¶äºŒ: ${player2Score} åˆ†`;
            }
        }
        
        /**
         * æ¸²æŸ“èµ·å§‹é é¢
         */
        function renderStartScreen() {
            player1Score = 0;
            player2Score = 0;
            
            // ç§»é™¤èˆŠçš„éµç›¤ç›£è½å™¨
            document.removeEventListener('keydown', handleKeyboardInput);

            // é¡¯ç¤ºåˆ†æ•¸é¡¯ç¤ºå…ƒç´ 
            document.getElementById('p1-score-display').classList.remove('hidden');
            document.getElementById('p2-score-display').classList.remove('hidden');

            appElement.innerHTML = `
                <div class="space-y-8 p-6 md:p-12 pt-12"> <!-- å¢åŠ  pt-12 è®“å…§å®¹é¿é–‹é ‚éƒ¨è¨ˆåˆ†æ¿ -->
                    <h1 class="text-5xl font-extrabold text-lime-700">å–®å…ƒ 8-3 åˆ†æ•¸çš„æ¯”å¤§å° PK æŒ‘æˆ°</h1>
                    <p class="text-2xl text-red-500 font-bold">é›™äºº PK æ¨¡å¼ï¼å…ˆç­”å°è€…å¾—åˆ†ï¼</p>
                    <div class="flex flex-col md:flex-row justify-around text-left text-xl space-y-4 md:space-y-0">
                        <div class="bg-blue-100 p-4 rounded-lg shadow-inner border-l-4 border-blue-500 flex-1 mx-2">
                            <h3 class="font-bold text-blue-700">âš”ï¸ ç©å®¶ä¸€ (å·¦ä¸Š)</h3>
                            <p class="text-sm text-gray-600 mt-2">è«‹é»æ“Šè¢å¹•æŒ‰éˆ•ã€‚</p>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li>é»æ“Šï¼šå¤§æ–¼ (&gt;)</li>
                                <li>é»æ“Šï¼šç­‰æ–¼ (=)</li>
                                <li>é»æ“Šï¼šå°æ–¼ (&lt;)</li>
                            </ul>
                        </div>
                        <div class="bg-red-100 p-4 rounded-lg shadow-inner border-r-4 border-red-500 flex-1 mx-2">
                            <h3 class="font-bold text-red-700">ğŸ›¡ï¸ ç©å®¶äºŒ (å³ä¸Š)</h3>
                            <p class="text-sm text-gray-600 mt-2">è«‹é»æ“Šè¢å¹•æŒ‰éˆ•ã€‚</p>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li>é»æ“Šï¼šå¤§æ–¼ (&gt;)</li>
                                <li>é»æ“Šï¼šç­‰æ–¼ (=)</li>
                                <li>é»æ“Šï¼šå°æ–¼ (&lt;)</li>
                            </ul>
                        </div>
                    </div>
                    <button id="startButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105 text-2xl mt-8">
                        é–‹å§‹ PKï¼ (${questions.length} é¡Œ)
                    </button>
                    <p class="text-sm text-gray-400 mt-6">
                        å°æç¤ºï¼šåŒåˆ†æ¯åˆ†æ•¸æ¯”è¼ƒæ™‚ï¼Œåªéœ€è¦çœ‹åˆ†å­çš„å¤§å°å–”ï¼
                    </p>
                </div>
            `;
            document.getElementById('startButton').addEventListener('click', () => {
                currentQuestionIndex = 0;
                renderQuestion();
            });
            updateScoreDisplay(); // ç¢ºä¿åˆ†æ•¸é‡ç½®ç‚º 0
        }

        /**
         * æ¸²æŸ“é¡Œç›®é é¢
         */
        function renderQuestion() {
            if (currentQuestionIndex >= questions.length) {
                renderCompletionScreen();
                return;
            }
            
            // ç§»é™¤èˆŠçš„éµç›¤ç›£è½å™¨
            document.removeEventListener('keydown', handleKeyboardInput);

            const q = questions[currentQuestionIndex];
            const isVisual = q.type === 'visual';
            isAnswerLocked = false; // è§£é–ç­”æ¡ˆé¸æ“‡

            // ç¢ºä¿åˆ†æ•¸é¡¯ç¤ºå…ƒç´ å¯è¦‹
            document.getElementById('p1-score-display').classList.remove('hidden');
            document.getElementById('p2-score-display').classList.remove('hidden');
            
            let coreComparisonHTML = '';

            if (isVisual) {
                // æ–°ç‰ˆé¢ï¼šåœ–å½¢å’Œåˆ†æ•¸å‚ç›´å°é½Šï¼Œç„¶å¾Œå…©çµ„ä¸¦æ’
                coreComparisonHTML = `
                    <div class="flex items-start justify-center space-x-4 md:space-x-12">
                        <!-- å·¦å´åˆ†æ•¸åŠåœ–å½¢ -->
                        <div class="flex flex-col items-center">
                            <div id="visual1" class="mb-4"></div>
                            ${createFractionHTML(q.n1, q.d1)}
                        </div>

                        <!-- æ¯”è¼ƒç¬¦è™Ÿ (èˆ‡åˆ†æ•¸ä¸­å¤®å°é½Š) -->
                        <div id="result-symbol" class="border-4 border-black bg-white h-16 w-16 flex items-center justify-center text-5xl font-extrabold text-gray-500 mt-20"></div>
                        
                        <!-- å³å´åˆ†æ•¸åŠåœ–å½¢ -->
                        <div class="flex flex-col items-center">
                            <div id="visual2" class="mb-4"></div>
                            ${createFractionHTML(q.n2, q.d2)}
                        </div>
                    </div>
                `;
            } else {
                // æ•¸å­—é¡Œç¶­æŒå–®è¡Œæ°´å¹³æ’åˆ—
                coreComparisonHTML = `
                    <div class="flex items-center justify-center space-x-2 md:space-x-6 h-28"> <!-- å¢åŠ é«˜åº¦ä¿æŒèˆ‡è¦–è¦ºé¡Œçš„è¦–è¦ºå¹³è¡¡ -->
                        ${createFractionHTML(q.n1, q.d1)}
                        <div id="result-symbol" class="border-4 border-black bg-white h-16 w-16 flex items-center justify-center text-5xl font-extrabold text-gray-500"></div>
                        ${createFractionHTML(q.n2, q.d2)}
                    </div>
                `;
            }


            appElement.innerHTML = `
                <div class="space-y-4 pt-12"> <!-- å¢åŠ  pt-12 é¿å…å…§å®¹è¢«é ‚éƒ¨è¨ˆåˆ†æ¿é®æ“‹ -->
                    <div class="text-xl font-semibold text-lime-600">PK æŒ‘æˆ° - ${q.title} (${currentQuestionIndex + 1}/${questions.length})</div>
                    <p class="text-3xl font-extrabold text-gray-800 mb-6">è«‹å¿«é€Ÿé¸æ“‡æ­£ç¢ºçš„æ¯”è¼ƒç¬¦è™Ÿï¼</p>
                    
                    <!-- é¡Œç›®ä¸»é«” -->
                    ${coreComparisonHTML}
                    
                    <!-- ç©å®¶æ“ä½œå€ï¼šä¿®æ­£ç‚ºæ°¸é å·¦å³ä¸¦æ’ -->
                    <div class="flex flex-row justify-between mt-8 md:mt-10 space-x-2">
                        <!-- ç©å®¶ä¸€æŒ‰éˆ• (å·¦) -->
                        <div id="p1-controls" class="flex flex-col space-y-3 p-4 bg-blue-50 rounded-lg border-2 border-blue-400 w-[49%]">
                            <h3 class="text-lg font-bold text-blue-700">ç©å®¶ä¸€</h3>
                            <!-- ç¢ºä¿æŒ‰éˆ•æœ‰è¶³å¤ çš„è§¸æ§é¢ç© -->
                            <!-- é †åºèª¿æ•´ï¼šå¤§æ–¼ (>) -->
                            <button data-player="1" data-answer=">" class="symbol-btn p1-btn text-4xl bg-blue-400 active:bg-blue-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> &gt; </button>
                            <!-- é †åºèª¿æ•´ï¼šç­‰æ–¼ (=) -->
                            <button data-player="1" data-answer="=" class="symbol-btn p1-btn text-4xl bg-blue-400 active:bg-blue-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> = </button>
                            <!-- é †åºèª¿æ•´ï¼šå°æ–¼ (<) -->
                            <button data-player="1" data-answer="<" class="symbol-btn p1-btn text-4xl bg-blue-400 active:bg-blue-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> &lt; </button>
                        </div>

                        <!-- ç©å®¶äºŒæŒ‰éˆ• (å³) -->
                        <div id="p2-controls" class="flex flex-col space-y-3 p-4 bg-red-50 rounded-lg border-2 border-red-400 w-[49%]">
                            <h3 class="text-lg font-bold text-red-700">ç©å®¶äºŒ</h3>
                            <!-- é †åºèª¿æ•´ï¼šå¤§æ–¼ (>) -->
                            <button data-player="2" data-answer=">" class="symbol-btn p2-btn text-4xl bg-red-400 active:bg-red-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> &gt; </button>
                            <!-- é †åºèª¿æ•´ï¼šç­‰æ–¼ (=) -->
                            <button data-player="2" data-answer="=" class="symbol-btn p2-btn text-4xl bg-red-400 active:bg-red-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> = </button>
                            <!-- é †åºèª¿æ•´ï¼šå°æ–¼ (<) -->
                            <button data-player="2" data-answer="<" class="symbol-btn p2-btn text-4xl bg-red-400 active:bg-red-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> &lt; </button>
                        </div>
                    </div>
                    
                    <div id="feedback" class="h-10 mt-6 text-xl font-bold"></div>
                    
                    <div class="flex justify-center space-x-4">
                        <button id="nextButton" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105 text-lg mt-4">
                            ä¸‹ä¸€é¡Œ
                        </button>
                    </div>
                </div>
            `;
            
            // æ¸²æŸ“è¦–è¦ºæ¨¡å‹ (åªé©ç”¨æ–¼è¦–è¦ºé¡Œ)
            if (isVisual) {
                const visual1Container = document.getElementById('visual1');
                const visual2Container = document.getElementById('visual2');

                // é¡¯ç¤ºå…©çµ„åœ–å½¢ï¼Œå¼·èª¿æ¯”è¼ƒ
                visual1Container.appendChild(createVisualModel(q.modelType, q.n1, q.d1));
                visual2Container.appendChild(createVisualModel(q.modelType, q.n2, q.d2));
            }

            // é‡æ–°ç¶å®šäº‹ä»¶ç›£è½å™¨ï¼Œä½¿ç”¨ e.currentTarget ç¢ºä¿é»æ“Šæˆ–è§¸æ§éƒ½èƒ½å–å¾—æ­£ç¢ºçš„æŒ‰éˆ•
            document.querySelectorAll('.symbol-btn').forEach(button => {
                // ç§»é™¤ hover:bg-xxx æ¨£å¼ï¼Œæ”¹ç”¨ active:bg-xxx æå‡è§¸æ§é«”é©—
                button.classList.remove('hover:bg-blue-500', 'hover:bg-red-500', 'hover:scale-105');
                button.addEventListener('click', (e) => handleAnswer(e.currentTarget.dataset.player, e.currentTarget.dataset.answer, e.currentTarget));
            });
            document.getElementById('nextButton').addEventListener('click', () => {
                currentQuestionIndex++;
                renderQuestion();
            });


            // å•Ÿç”¨éµç›¤ç›£è½å™¨
            document.addEventListener('keydown', handleKeyboardInput);
            updateScoreDisplay();
        }

        /**
         * è™•ç†éµç›¤è¼¸å…¥
         * @param {KeyboardEvent} event éµç›¤äº‹ä»¶
         */
        function handleKeyboardInput(event) {
            if (isAnswerLocked) return;
            const key = event.key.toLowerCase();
            
            let player, answer, targetButton;

            if (player1Keys.hasOwnProperty(key)) {
                player = '1';
                answer = player1Keys[key];
                targetButton = document.querySelector(`.p1-btn[data-answer="${answer}"]`);
            } else if (player2Keys.hasOwnProperty(key)) {
                player = '2';
                answer = player2Keys[key];
                targetButton = document.querySelector(`.p2-btn[data-answer="${answer}"]`);
            } else {
                return; // å¿½ç•¥ééŠæˆ²éµ
            }

            if (targetButton) {
                // æ¨¡æ“¬é»æ“Šæ•ˆæœ
                targetButton.classList.add('scale-95', 'opacity-80');
                setTimeout(() => targetButton.classList.remove('scale-95', 'opacity-80'), 150);
                handleAnswer(player, answer, targetButton);
            }
        }

        /**
         * è™•ç†ä½¿ç”¨è€…é»æ“Š/éµç›¤è¼¸å…¥ç­”æ¡ˆ
         * @param {string} player ç©å®¶ '1' æˆ– '2'
         * @param {string} userAnswer ç©å®¶é¸æ“‡çš„ç¬¦è™Ÿ
         * @param {HTMLElement} targetElement è§¸ç™¼äº‹ä»¶çš„æŒ‰éˆ•å…ƒç´ 
         */
        function handleAnswer(player, userAnswer, targetElement) {
            if (isAnswerLocked) return;

            const correctAnswer = questions[currentQuestionIndex].answer;
            const feedbackElement = document.getElementById('feedback');
            const resultSymbolElement = document.getElementById('result-symbol');
            const nextButton = document.getElementById('nextButton');


            // æª¢æŸ¥ç­”æ¡ˆ
            if (userAnswer === correctAnswer) {
                isAnswerLocked = true; // é–å®šéŠæˆ²ï¼Œé˜²æ­¢å¦ä¸€äººä½œç­”

                // ç§»é™¤éµç›¤ç›£è½å™¨
                document.removeEventListener('keydown', handleKeyboardInput);

                // æ›´æ–°åˆ†æ•¸
                if (player === '1') {
                    player1Score++;
                } else {
                    player2Score++;
                }
                updateScoreDisplay();

                // é¡¯ç¤ºæ­£ç¢ºç¬¦è™Ÿ
                resultSymbolElement.textContent = correctAnswer;
                resultSymbolElement.classList.remove('text-gray-500');
                resultSymbolElement.classList.add('text-green-600', 'animate-bounce');


                // çµ¦äºˆåé¥‹
                feedbackElement.textContent = `ç©å®¶ ${player} ç­”å°äº†ï¼æ­å–œç²å¾— 1 åˆ†ï¼ ğŸ‰`;
                feedbackElement.classList.remove('text-red-500');
                feedbackElement.classList.add('text-green-600');

                // æ¨™ç¤ºè´å®¶æŒ‰éˆ•
                targetElement.classList.remove('bg-blue-400', 'bg-red-400', 'active:bg-blue-600', 'active:bg-red-600');
                targetElement.classList.add('bg-yellow-500', 'ring-4', 'ring-yellow-300', 'text-gray-800');

                // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
                document.querySelectorAll('.symbol-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed', 'shadow-none', 'active:scale-100');
                });
                
                // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
                nextButton.classList.remove('hidden');

            } else {
                // éŒ¯èª¤ç­”æ¡ˆï¼šçµ¦äºˆçŸ­æš«è¦–è¦ºæ‡²ç½° (é–ƒçˆ)
                targetElement.classList.remove('bg-blue-400', 'bg-red-400', 'active:bg-blue-600', 'active:bg-red-600');
                targetElement.classList.add('bg-red-200', 'ring-2', 'ring-red-500', 'animate-pulse');
                
                // è®“æŒ‰éˆ•åœ¨éŒ¯èª¤æ™‚ç¦ç”¨çŸ­æš«æ™‚é–“ï¼Œé¿å…é€£é»
                targetElement.disabled = true;

                setTimeout(() => {
                    targetElement.classList.remove('bg-red-200', 'ring-2', 'ring-red-500', 'animate-pulse');
                    if (player === '1') {
                        targetElement.classList.add('bg-blue-400', 'active:bg-blue-600');
                    } else {
                        targetElement.classList.add('bg-red-400', 'active:bg-red-600');
                    }
                    targetElement.disabled = false; // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
                }, 300);

                // æç¤ºå¦ä¸€ä½ç©å®¶
                feedbackElement.textContent = `ç©å®¶ ${player} ç­”éŒ¯äº†ï¼æ›å¦ä¸€ä½è©¦è©¦çœ‹ï¼ ğŸ¤”`;
                feedbackElement.classList.remove('text-green-600');
                feedbackElement.classList.add('text-red-500');
            }
        }

        /**
         * æ¸²æŸ“å®Œæˆé é¢
         */
        function renderCompletionScreen() {
            document.removeEventListener('keydown', handleKeyboardInput);
            
            // éš±è—åˆ†æ•¸é¡¯ç¤ºå…ƒç´ 
            document.getElementById('p1-score-display').classList.add('hidden');
            document.getElementById('p2-score-display').classList.add('hidden');
            
            let winnerMessage;
            let winnerColor;

            if (player1Score > player2Score) {
                winnerMessage = `ğŸ† æ­å–œç©å®¶ä¸€è´å¾—å‹åˆ©ï¼`;
                winnerColor = 'text-blue-600';
            } else if (player2Score > player1Score) {
                winnerMessage = `ğŸ† æ­å–œç©å®¶äºŒè´å¾—å‹åˆ©ï¼`;
                winnerColor = 'text-red-600';
            } else {
                winnerMessage = `ğŸ¤ é›™æ–¹å¹³æ‰‹ï¼çœŸæ˜¯å‹¢å‡åŠ›æ•µçš„æ¯”è³½ï¼`;
                winnerColor = 'text-yellow-600';
            }

            appElement.innerHTML = `
                <div class="space-y-8 p-6 md:p-12">
                    <h1 class="text-6xl font-extrabold text-lime-700 animate-pulse">æŒ‘æˆ°çµæŸï¼</h1>
                    <p class="text-4xl font-bold ${winnerColor}">${winnerMessage}</p>
                    <div class="flex justify-around text-3xl font-semibold">
                        <p class="text-blue-600">ç©å®¶ä¸€å¾—åˆ†ï¼š${player1Score} åˆ†</p>
                        <p class="text-red-600">ç©å®¶äºŒå¾—åˆ†ï¼š${player2Score} åˆ†</p>
                    </div>
                    <button id="restartButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105 text-xl mt-4">
                        å†ç©ä¸€æ¬¡ PKï¼
                    </button>
                </div>
            `;
            document.getElementById('restartButton').addEventListener('click', renderStartScreen);
            // ä¸éœ€è¦å†å‘¼å« updateScoreDisplayï¼Œå› ç‚ºçµæŸç•«é¢å·²ç¶“é¡¯ç¤ºæœ€çµ‚åˆ†æ•¸
        }

        // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•é»
        window.onload = function() {
            // åˆå§‹åŒ–æ™‚ç›´æ¥é¡¯ç¤ºé–‹å§‹é é¢
            renderStartScreen();
        };

        // ç‚ºäº†éµå¾ª Immersive ç’°å¢ƒçš„è¦ç¯„ï¼Œé›–ç„¶æœ¬ app ä¸ä½¿ç”¨ Firestoreï¼Œ
        // ä»éœ€ç¢ºä¿ä¸æœƒå› ç‚ºæœªå®šç¾©çš„ Firebase è®Šæ•¸è€Œå ±éŒ¯ã€‚
        // ä»¥ä¸‹ç‚º Firebase ç›¸é—œçš„ç©ºå‡½æ•¸ï¼Œç¢ºä¿ä»£ç¢¼å¥å£¯æ€§ã€‚
        if (typeof initializeApp === 'undefined') {
            const initializeApp = () => ({});
            const getAuth = () => ({});
            const getFirestore = () => ({});
        }
    </script>
</body>
</html>
